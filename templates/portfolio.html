{% extends "layout.html" %}

{% block content %}

<script>
    $(document).ready(function() {
        $("#addStockOpenModal").click(function() {
            $('.ui.basic.modal').modal('show');
        });

        $("#addStockConfirm").click(function() {
            var ticker = $("#addStockTicker").val();
            var buyPrice = $("#addStockBuyPrice").val();
            var buyAmount = $("#addStockBuyAmount").val();
            var buyFee = $("#addStockBuyFee").val();
            console.log(ticker);
            console.log(buyPrice);
            console.log(buyAmount);
            console.log(buyFee);

            $.ajax({
                url: '/finances/stocks/portfolio/add-stock',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    "ticker" : ticker,
                    "buyPrice" : buyPrice,
                    "buyAmount" : buyAmount,
                    "buyFeeEur" : buyFee
                }),
                dataType: 'json'
            });

            $('.ui.basic.modal').modal('hide');
            window.location.reload();
        });

        let n = $("#stockTable >tbody >tr").length;
        let v;
        for(let i = 1; i <= n; i++) {
            //color value change fields
            v =parseFloat($("#valueChange" + [i]).text());
            if(v < 0) $("#valueChange" + [i]).addClass("negative");
            else if (v > 0) $("#valueChange" + [i]).addClass("positive");

            //color relative value change fields
            v =$("#relValueChange" + [i]).text();
            v = parseFloat(v.substring(0, v.length - 2));
            if(v < 0) $("#relValueChange" + [i]).addClass("negative");
            else if (v > 0) $("#relValueChange" + [i]).addClass("positive");

            //color profit fields
            v =$("#profit" + [i]).text();
            v = parseFloat(v.substring(0, v.length - 2));
            if(v < 0) $("#profit" + [i]).addClass("negative");
            else if (v > 0) $("#profit" + [i]).addClass("positive");
        }       
    });
</script>

<div style="padding: 2ex;">

    <!-- Modal to add a stock to the watchlist -->
    <div class="ui basic modal">
        <!-- header -->
        <div class="ui icon header">
            <i class="chart area icon"></i>
            Add Stock to Portfolio
        </div>

        <!-- inputs -->
        <div class="ui input">
            <input type="text" id="addStockTicker" placeholder="Stock Ticker ...">
        </div><br>
        
        <div class="ui input">
            <input type="number" id="addStockBuyPrice" placeholder="Buy Price ...">
        </div><br>
        
        <div class="ui input">
            <input type="number" id="addStockBuyAmount" placeholder="Buy Amount ...">
        </div><br>
        
        <div class="ui input">
            <input type="number" id="addStockBuyFee" placeholder="Buy Fee ...">
        </div><br>

        <div class="actions">

            <!-- cancel button -->
            <div id="addStockCancel" class="ui red basic cancel inverted button">
                <i class="remove icon"></i>
                Cancel
            </div>

            <!-- confirm button -->
            <div id="addStockConfirm" class="ui green ok inverted button">
                <i class="checkmark icon"></i>
                Confirm
            </div>
        </div>
    </div>
    
    <!-- Button to open the add stock modal -->
    <div class="ui animated button" tabindex="0" id="addStockOpenModal">
        <div class="hidden content">Add</div>
        <div class="visible content">
            <i class="plus icon"></i>
        </div>
    </div>

    <!-- Stock table -->
    <table id="stockTable" class="ui sortable celled table">
        <thead>
            <tr>
                <th>Ticker</th>
                <th>Value</th>
                <th>Value Change 1D</th>
                <th>Relative Value Change 1D</th>
                <th>Profit</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            {% if stocks is not none %}
                {% for stock in stocks %}
                <tr>
                    <td>{{ stock[0] }}</td>
                    <td>{{ stock[1] }}</td>
                    <td id="valueChange{{loop.index}}">{{ stock[2] }}</td>
                    <td id="relValueChange{{loop.index}}">{{ stock[3] }}</td>
                    <td id="profit{{loop.index}}">{{ stock[4] }}</td>
                </tr>
                {% endfor %}
            {% endif %}
        </tbody>
        <tfoot>
            <tr>
                <th>Number of Stocks: {{ stocks|length }}</th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </tfoot>
    </table>
</div>

{% endblock %}